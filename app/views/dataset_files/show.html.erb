<div class="home-box-table">
	<%= link_to "< Back to data collection", main_app.user_datasets_path(current_user) %>
	<h2><%= @dataset_file.title %></h2>
	<strong>Description: </strong><p><%= @dataset_file.description %></p>
	<strong>Last updated: </strong><p><%= time_or_date(@dataset_file.updated_at) %></p>
	<a href="https://csvlint.io/?uri=<%= @s3_file %>"><img src="https://csvlint.io/?uri=<%= @s3_file%>&format=svg" alt="CSVlint validation result" /></a>
	<%= @s3_file %>
	<h2>Preview</h2>
	<div class="table-container">
	  <table class="table table-striped table-bordered" id="data-table">
	    <thead id="data-table-head"></thead>
	    <tbody id="data-table-body"></tbody>
	  </table>
	</div>
</div>

<div id="loading" style="display: none;">
  <h1>Loading...</h1>
  <i class="fa fa-circle-o-notch fa-spin fa-fw"></i>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.7/papaparse.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/floatthead/2.0.3/jquery.floatThead.min.js"></script>

<script>
	function dataTable () {
		// var url = "<%= @s3_file %>"
		var url = "https://octo-dev-lang.s3.eu-west-1.amazonaws.com/uploads/ff96d8c5-5cef-4bb9-9cfb-ce92b54c140e/counting-two.csv?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJC4FTS6WY6R74IDQ%2F20180316%2Feu-west-1%2Fs3%2Faws4_request&X-Amz-Date=20180316T090320Z&X-Amz-Expires=200000&X-Amz-SignedHeaders=host&X-Amz-Signature=42c3dcc6602ffa3d66873e1257680dae002184ac0193f6fc777cfd8a57cca663"
		Papa.SCRIPT_PATH = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.7/papaparse.min.js'

	  $('#loading').show()
	  $('#data-table-body').hide()

	  Papa.parse(url, {
	    download: true,
			header: true,
	    step: function(row) {
				$('#data-table-head').html(dataHead(row.meta['fields']))
	      $('#data-table-body').append(dataRow(row.data[0]))
	    },
	    complete: function() {
	      $('#loading').hide()

	      var $table = $('table.table');
	      $table.floatThead({
	        scrollContainer: function($table) {
	          return $table.closest('.table-container');
	        }
	      });

	      $('#data-table-body').show()
	      $('#download-csv').removeClass('hidden')
	    }
	  });

		function dataHead (data) {
			var s = '<tr>'

			$.each(data, function(index, value) {
					s += '<th>'
					s += value
					s += '</th>'
			})

			s += '</tr>'

			return s
		}

	  function dataRow (data) {
	    var s = '<tr>'

	    $.each(data, function(index, value) {
	      s += '<td>'
	      s += value
	      s += '</td>'
	    })

	    s += '</tr>'

	    return s
	  }
	};

	dataTable()

</script>
