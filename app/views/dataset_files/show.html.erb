<div class="home-box-dashboard">
	<%= link_to "< Back to data collection: #{@dataset.name}", files_path(@dataset.id) %>
	<div class="head-dataset">
		<div class="col-md-3">
			<h2><%= @dataset_file.title %></h2>
		</div>
		<div class="col-md-9">
			<% if !@dataset.published_status %>
				<%= bs_button_to "View on Github", @dataset.github_url, target: "_blank", rel: "alternate",:class => "btn btn-tertiary disabled" %>
			<% else %>
				<%= bs_button_to "View on Github", @dataset.github_url, target: "_blank", rel: "alternate",:class => "btn btn-tertiary" %>
			<% end %>
		</div>
	</div>
	<div class="box-dataset">
	  <div class="row">
			<%= link_to("Edit", edit_dataset_path(@dataset.id)) %><br />
			<strong>Description: </strong><p><%= @dataset_file.description %></p>
			<strong>Schema: </strong><p><%= @dataset_file.dataset_file_schema.name %></p>
			<strong>Last updated: </strong><p><%= time_or_date(@dataset_file.updated_at) %></p>
			<strong>Published: </strong>
			<% if @dataset.published_status %>
	      <p>Yes</p>
			<% else %>
	      <p>No - this file is not public yet</p>
			<% end %>
		</div>
	</div>
	<h2>Preview</h2>
	<%= bs_button_to "Download CSV", @s3_file, rel: "alternate", :class => "btn btn-secondary" %>
	<div class="box-dataset">
		<div class="table-container">
			<table class="table table-striped table-bordered" id="data-table">
				<thead id="data-table-head"></thead>
				<tbody id="data-table-body"></tbody>
			</table>
		</div>
	</div>
</div>

<div id="loading" style="display: none;">
  <h1>Loading...</h1>
  <i class="fa fa-circle-o-notch fa-spin fa-fw"></i>
</div>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.7/papaparse.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/floatthead/2.0.3/jquery.floatThead.min.js"></script>

<script>
	function dataTable () {
		Papa.SCRIPT_PATH = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.7/papaparse.min.js'

		var url = "<%= @s3_file %>"
		url = url.replace(/&amp;/g, '&');

	  $('#loading').show()
	  $('#data-table-body').hide()

	  Papa.parse(url, {
	    download: true,
			header: true,
	    step: function(row) {
				$('#data-table-head').html(dataHead(row.meta['fields']))
	      $('#data-table-body').append(dataRow(row.data[0]))
	    },
	    complete: function() {
	      $('#loading').hide()

	      var $table = $('table.table');
	      $table.floatThead({
	        scrollContainer: function($table) {
	          return $table.closest('.table-container');
	        }
	      });

	      $('#data-table-body').show()
	      $('#download-csv').removeClass('hidden')
	    }
	  });

		function dataHead (data) {
			var s = '<tr>'

			$.each(data, function(index, value) {
					s += '<th>'
					s += value
					s += '</th>'
			})

			s += '</tr>'

			return s
		}

	  function dataRow (data) {
	    var s = '<tr>'

	    $.each(data, function(index, value) {
	      s += '<td>'
	      s += value
	      s += '</td>'
	    })

	    s += '</tr>'

	    return s
	  }
	};

	dataTable()

</script>
